![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/master/Media/ms-cloud-workshop.png "Microsoft Cloud Workshops")

<div class="MCWHeader1">
Managing and Monitoring Azure Workloads
</div>

<div class="MCWHeader2">
Whiteboard design session trainer guide
</div>

<div class="MCWHeader3">
May 2020
</div>

Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.

Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.

The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein.

© 2020 Microsoft Corporation. All rights reserved.

Microsoft and the trademarks listed at https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.

**Contents**

<!-- TOC -->

- [Trainer information](#trainer-information)
  - [Role of the trainer](#role-of-the-trainer)
  - [Whiteboard design session flow](#whiteboard-design-session-flow)
  - [Before the whiteboard design session: How to prepare](#before-the-whiteboard-design-session-how-to-prepare)
  - [During the whiteboard design session: Tips for an effective whiteboard design session](#during-the-whiteboard-design-session-tips-for-an-effective-whiteboard-design-session)
- [Managing and Monitoring Azure Workloads - Whiteboard Design Session Student Guide](#managing-and-monitoring-azure-workloads---whiteboard-design-session-student-guide)
  - [Abstract and learning objectives](#abstract-and-learning-objectives)
  - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study)
    - [Customer background](#customer-background)
    - [Technical background](#technical-background)
    - [Current situation](#current-situation)
    - [Customer needs](#customer-needs)
    - [Customer objections](#customer-objections)
  - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution)
  - [Step 3: Present the solution](#step-3-present-the-solution)
  - [Wrap-up](#wrap-up)
  - [Additional references](#additional-references)
- [Building a resilient IaaS architecture whiteboard design session trainer guide](#building-a-resilient-iaas-architecture-whiteboard-design-session-trainer-guide)
  - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study-1)
  - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution-1)
  - [Step 3: Present the solution](#step-3-present-the-solution-1)
  - [Wrap-up](#wrap-up-1)
  - [Preferred solution](#preferred-solution)
  - [Checklist of preferred objection handling](#checklist-of-preferred-objection-handling)
  - [Customer quote (to be read back to the attendees at the end)](#customer-quote-to-be-read-back-to-the-attendees-at-the-end)

<!-- /TOC -->

# Trainer information

Thank you for taking time to support the whiteboard design sessions as a trainer!

## Role of the trainer

An amazing trainer:

-   Creates a safe environment in which learning can take place.

-   Stimulates the participant's thinking.

-   Involves the participant in the learning process.

-   Manages the learning process (on time, on topic, and adjusting to benefit participants).

-   Ensures individual participant accountability.

-   Ties it all together for the participant.

-   Provides insight and experience to the learning process.

-   Effectively leads the whiteboard design session discussion.

-   Monitors quality and appropriateness of participant deliverables.

-   Effectively leads the feedback process.

## Whiteboard design session flow 

Each whiteboard design session uses the following flow:

**Step 1: Review the customer case study (15 minutes)**

Outcome 

Analyze your customer's needs.

-   Customer's background, situation, needs and technical requirements

-   Current customer infrastructure and architecture

-   Potential issues, objectives and blockers

**Step 2: Design a proof of concept solution (60 minutes)**

Outcome 

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

-   Determine your target customer audience.

-   Determine customer's business needs to address your solution.

-   Design and diagram your solution.

-   Prepare to present your solution.

**Step 3: Present the solution (30 minutes)**

Outcome

Present solution to your customer.

-   Present solution

-   Respond to customer objections

-   Receive feedback

**Wrap-up (15 minutes)**

-   Review preferred solution

## Before the whiteboard design session: How to prepare

Before conducting your first whiteboard design session:

-   Read the Student guide (including the case study) and Trainer guide.

-   Become familiar with all key points and activities.

-   Plan the point you want to stress, which questions you want to drive, transitions, and be ready to answer questions.

-   Prior to the whiteboard design session, discuss the case study to pick up more ideas.

-   Make notes for later.

## During the whiteboard design session: Tips for an effective whiteboard design session

**Refer to the Trainer guide** to stay on track and observe the timings.

**Do not expect to memorize every detail** of the whiteboard design session.

When participants are doing activities, you can **look ahead to refresh your memory**.

-   **Adjust activity and whiteboard design session pace** as needed to allow time for presenting, feedback, and sharing.

-   **Add examples, points, and stories** from your own experience. Think about stories you can share that help you make your points clearly and effectively.

-   **Consider creating a "parking lot"** to record issues or questions raised that are outside the scope of the whiteboard design session or can be answered later. Decide how you will address these issues, so you can acknowledge them without being derailed by them.

***Have fun**! Encourage participants to have fun and share!*

**Involve your participants.** Talk and share your knowledge but always involve your participants, even while you are the one speaking.

**Ask questions** and get them to share to fully involve your group in the learning process.

**Ask first**, whenever possible. Before launching into a topic, learn your audience's opinions about it and experiences with it. Asking first enables you to assess their level of knowledge and experience and leaves them more open to what you are presenting.

**Wait for responses**. If you ask a question such as, "What is your experience with (fill in the blank)?" then wait. Do not be afraid of a little silence. If you leap into the silence, your participants will feel you are not serious about involving them and will become passive. Give participants a chance to think, and if no one answers, patiently ask again. You will usually get a response.

# Managing and Monitoring Azure Workloads - Whiteboard Design Session Student Guide

## Abstract and learning objectives 

In this whiteboard design session, you will look at how to design monitoring and management solutions in Azure. Your focus will be on a partner Managed Service Provider scenario, where management must be provided at scale across a large number of customers.

At the end of the workshop, you will be better able to design and use Azure monitoring and management tools, including Azure Monitor Workbooks, Log Analytics, Azure Alerts, and Azure Automation. You will also understand how to deploy these technologies across a large portfolio of customers using a variety of automation technologies. You will also better understand the challenges involved in managing Azure solutions at scale.

## Step 1: Review the customer case study 

**Outcome** 

Analyze your customer’s needs.

Timeframe: 15 minutes 

Directions: With all participants in the session, the facilitator/SME presents an overview of the customer case study along with technical tips. 

1.  Meet your table participants and trainer. 

2.  Read all of the directions for steps 1–3 in the student guide. 

3.  As a table team, review the following customer case study.
 
### Customer background

Contoso Cloud Services (CCS) is a Microsoft Partner providing a broad portfolio of cloud-focused IT solutions to its customers.

CCS was founded in Atlanta in 1998, originally as Contoso IT Services. The original business successfully rode the dot-com bubble, creating and hosting web sites as customers established their on-line presence. The hosting side of the business grew into a substantial managed services business, with CCS building hosting facilities in Atlanta, New York, Denver and San Jose.

The CEO of CCS, Jack Walsh, was quick to recognize that the dawn of the cloud era would transform his industry. In 2015 he re-branded the company as Contoso Cloud Services and set in place a new business strategy offering cloud-based and hybrid cloud services. Given CCS’s long history as a Microsoft partner, Microsoft Azure was the natural choice as preferred public cloud provider.

CCS has built a broad base of around 600 managed services customers, mostly medium-sized and large businesses. More recently CCS has also acquired a handful of enterprise customers, reflecting the company’s ongoing growth and success.

### Technical background

The current CCS portfolio of managed customer applications comprises:
-   Legacy on-premises applications hosted in CCS’s four datacenters. The strategy is to migrate these solutions to cloud-based alternatives as hardware ages, and eventually to reduce the datacentre footprint from 4 sites to 2.
-   Hybrid solutions, using an 200Mbps ExpressRoute connection supplied by the existing CCS WAN provider
-   Cloud-only customer solutions. These comprise both IaaS solutions (mostly arising from lift-and-shift migrations) and a smaller but growing portfolio of modernized PaaS-based applications.

CCS is a direct CSP. CSP Azure subscriptions are used by most customers. However, some customers are using pay-as-you-go subscriptions which they acquired before engaging CCS, and their enterprise customers use EA subscriptions.

### Current situation

As head of Cloud Operations for Contoso Cloud Services, you are responsible for keeping all your in-house and customer managed services healthy, secure and available 100% of the time. As your cloud business grows, you need to scale your operations activities accordingly—but you can only use the resources your already have.

Currently, your team manages each customer and application individually--so as the number of customers and applications grows, so does your workload. Pretty soon, the team aren't going to be able to cope. The only solution is to improve your teams' efficiency.

Your challenge is to redesign your operations processes for horizontal scale. You need to create efficient processes that enable your team to deliver core operations scenarios—such as health alerts, dashboards, backup and patching—across your growing customer base.

### Customer needs 

1.	**Subscription access** Access to customer subscriptions uses a combination of CSP ‘Act On Behalf Of’ (AOBO) and AAD B2B Collaboration. Managing access as team members change is a challenge, and some enterprise customers are disgruntled at the overhead on their side of managing changes to B2B guest accounts. CCS need a solution that provides access to customer subscriptions without undue customer overhead, full transparency, and fine-grained access control.

2.	**Backup configuration and monitoring** A key part of CCS’s offerings is backup management. CCS uses Azure Backup for backup of both on-premises and cloud-based servers and databases. Backup monitoring and management is a growing time sink for the operations team. In a recent incident it was found that backup jobs had been failing on one customer application for the past 2 months. Alerts had failed due to a missing diagnostics logging configuration. No one knows how many other applications are similarly affected. CCS need a scalable and reliable backup monitoring solution.

3.	**Patch management** CCS are using System Center for patch management for both on-premises and cloud-based servers. Their goal is to deprecate System Center in favour of a cloud-based alternative. This must provide comprehensive coverage across their entire server estate (on-premises/cloud, Linux/Windows).

4.	**VM and server monitoring** CCS are managing a large number of VMs across their customer subscriptions. VM diagnostics and monitoring has been configured for each application over time, using a variety of approaches. These include Azure metrics, diagnostics storage accounts, and Log Analytics. CCS would like to settle on a unified approach to server monitoring across their entire estate, including on-premises machines.

5.  **Automation of manual tasks** Occasionally, CCS need to make configuration changes to on-premises servers or to Azure-based applications. A diverse and unpredictable range of activities is involved. Examples from the past 6 months include changing the endpoint for a file share, installing a new anti-malware product, rotating passwords and auditing database accounts. These tasks are currently carried out manually. CCS are seeking a general-purpose solution to enable these manual tasks to be automated.

6.  **PaaS monitoring** CCS are experienced at monitoring IaaS-based workloads. They are less experienced with PaaS workloads, and are unsure what level of monitoring they need to implement vs what is taken care of by the cloud provider. As the number of managed PaaS applications increases, they need to define best practice patterns for SQL Database and Web App monitoring and alerts.

7.  **VM and server compliance** An internal security audit recently identified several on-premises and Azure servers which did not comply with CCS standards. They need a way to prevent this happening in future.

8.  **Cost management** As Azure spending increases, there have been several incidents in which CCS customers have complained about unnecessary spend on their Azure bill or questioned the value that Azure is bringing to their organization. CCS need a way to manage, report and optimize Azure costs for their customers.

### Customer objections 

1.  Cost is a concern. As well as being cost-efficient, CCS prefer solutions that keep any costs associated with managing a customer solution within the customer subscription, rather than centralizing management costs into a CCS subscription and then having to apportion across customers.

2.  CCS are finding that their new enterprise customers are more demanding regarding security and compliance. How can CCS demonstrate their services meet enterprise standards for secure operations?

## Step 2: Design a proof of concept solution

**Outcome** 

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format. 

Timeframe: 60 minutes

**Design**

Directions: With all participants in your group, respond to the following questions on a flip chart or (virtual) white board.

1.  **Subscription access** Design a solution to allow the CCS operations team with access to customer subscriptions.
    - The solution should support role-based access control, so the customer has visibility and control over which permissions are granted to CCS.
    - The solution should support user groups, so changes to the CCS operations team do not require customer involvement.
    - There solution should support all subscription types (PAYG, CSP, EA, etc).

    Are there any Azure features which are not compatible with your proposed solution?

2.  **Backup configuration and monitoring** How can CCS monitor Azure Backup health? Design a solution that enables:
    - Visibility into backup health across all customers
    - Identify VMs without backup enabled
    - Raise alerts upon backup failure, across all customers
    - Ensure backup monitoring is correctly consistently applied to all Recovery Services Vaults

    Does your solution scale to the number of customers and subscriptions managed by CCS?

3.  **Patch management** What alternatives to System Center does Azure offer for patch management? Design an approach that offers:
    - Support for on-premises and cloud-based servers
    - Support for both Windows Server and Linux
    - Automatic on-boarding for Azure virtual machines and VM scale sets

    How does your solution scale patch management across the CCS customer base?

4.  **VM and server monitoring** Design a solution for monitoring Azure VMs and on-premises servers. Your solution should support:
    - Streamlined onboarding of all Azure VMs and selected on-premises servers
    - Support for dashboards and alerts based on both metrics and logs. 
    - Customer billing according to usage
    - Compliance with Enterprise customer security requirements that all logs remain within their subscription boundary

    How can you ensure your solution is deployed consistently across all CCS customers, for data gathering, alert configuration, and reporting?

    Can your solution deliver flexible and highly configurable dashboards of key performance data?
    
    Can your dashboards show data aggregated across the CCS customer base? What limitations apply?

5.  **Automation of manual tasks** How can CCS automate their manual configuration tasks? Your solution must support:
    - Automation of Azure resource configuration tasks (e.g. VM resize, disk encryption, network changes)
    - Automation of operations for Azure VMs (e.g. rotating passwords, installing or uninstalling software, auditing permissions)
    - Automation of operations for on-premises servers

    How can you deploy automation at scale across the CCS customer base?

    How can you review the success or failure of each automation task, on each resource?

    Automating common tasks is a substantial investment in IP. How can you protect the confidentiality of this investment?

6.  **PaaS monitoring** Design a solution for monitoring PaaS services, in particular Azure SQL Database and Azure Web Apps. Your solution should support:
    - Gathering key metrics and log data for alerting and investigation of incidents
    - Configuration of alerts in the event of performance degradation (e.g. increased latency), errors, or critical events.

    What can you do to make your monitoring more representative of the end-user experience?

    A customer raises a support ticket claiming their application is 'slow'. How can your monitoring help investigate the cause?

7.  **VM and server compliance**  Propose a solution that enables CCS to audit the compliance of their entire server estate - Windows and Linux, on-premises and cloud.

    Your solution should support a wide range of common OS configuration issues, such as members of the local administrator group, password complexity, installed applications, and trusted certificates. The solution should also be extensible to support new issues as required by CCS.

    Explain how this solution scales to all CCS customers.

8.  **Cost management** Explain how CCS can meet their cost management requirements. These include:
    - Visibility into current and historical spend, with the ability to segment the data by a variety of categories (such as location, resource type, or tags)
    - Forecast of future spend
    - Cost saving recommendations
    - Configuration of spending alerts, including alerting at 1-day granularity in case of a spike in spending

    Cost reports should be available to customers, including CSP customers. However, any CSP discounts should be confidential to CCS.

**Prepare**

Directions: With all participants at your table: 

1.  Identify any customer needs that are not addressed with the proposed solution.

2.  Identify the benefits of your solution.

3.  Determine how you will respond to the customer’s objections.

## Step 3: Present the solution

**Outcome**
 
Present a solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 30 minutes

**Presentation** 

Directions:
1.  Pair with another table.

2.  One table is the Microsoft team and the other table is the customer.

3.  The Microsoft team presents their proposed solution to the customer.

4.  The customer makes one of the objections from the list of objections.

5.  The Microsoft team responds to the objection.

6.  The customer team gives feedback to the Microsoft team. 

7.  Tables switch roles and repeat Steps 2–6.

##  Wrap-up 

Timeframe: 15 minutes

Directions: Tables reconvene with the larger group to hear the facilitator/SME share the preferred solution for the case study.

##  Additional references

|                                         |                                                                   |
|-----------------------------------------|:-----------------------------------------------------------------:|
| **Description**                         | **Links**                                                         |
| Microsoft Azure Reference Architectures | <https://docs.microsoft.com/azure/guidance/guidance-architecture> |
| Azure Lighthouse                        | <https://docs.microsoft.com/azure/lighthouse/>                    |
| Azure Backup Explorer                   | <https://docs.microsoft.com/azure/backup/monitor-azure-backup-with-backup-explorer>                        |
| Azure Arc for Servers                   | <https://docs.microsoft.com/azure/azure-arc/servers/overview>     |
| VM Guest Policy                         | <https://docs.microsoft.com/azure/governance/policy/concepts/guest-configuration>     |
| Azure Monitor for VMs                   | <https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-overview>   |
| Azure Automation                        | <https://docs.microsoft.com/azure/automation/automation-intro>   |
| Azure Update Management                 | <https://docs.microsoft.com/azure/automation/automation-update-management>  |
| Web App monitoring                      | <https://docs.microsoft.com/azure/architecture/reference-architectures/app-service-web-app/app-monitoring> |
| SQL Database monitoring                 | <https://docs.microsoft.com/azure/sql-database/sql-database-monitor-tune-overview>    |
| Azure Cost Management                   | <https://docs.microsoft.com/en-us/azure/cost-management-billing/ > |
|                                         |                                                                   |
                                        

# Building a resilient IaaS architecture whiteboard design session trainer guide

## Step 1: Review the customer case study

-   Check in with your table participants to introduce yourself as the trainer.

-   Ask, "What questions do you have about the customer case study?"

-   Briefly review the steps and timeframes of the whiteboard design session.

-   Ready, set, go! Let the table participants begin.


## Step 2: Design a proof of concept solution

-   Check in with your tables to ensure that they are transitioning from step to step on time.

-   Provide some feedback on their responses to the business needs and design.

    -   Try asking questions first that will lead the participants to discover the answers on their own.
    
-   Provide feedback for their responses to the customer's objections.

    -   Try asking questions first that will lead the participants to discover the answers on their own.

## Step 3: Present the solution

-   Determine which table will be paired with your table before Step 3 begins.

-   For the first round, assign one table as the Microsoft team and the other table as the customer.

-   Have the Microsoft team present their solution to the customer team.

    -   Have the customer team provide one objection for the Microsoft team to respond to.
    
    -   The presentation and objections should be no longer than 15 minutes.
    
    -   If needed, the trainer may also provide feedback.

## Wrap-up

   -   Have the table participants reconvene with the larger session group to hear the facilitator/SME share the following preferred solution.

## Preferred solution


1.  **Subscription access** Design a solution to allow the CCS operations team with access to customer subscriptions.
    - The solution should support role-based access control, so the customer has visibility and control over which permissions are granted to CCS.
    - The solution should support user groups, so changes to the CCS operations team do not require customer involvement.
    - There solution should support all subscription types (PAYG, CSP, EA, etc).

    Are there any Azure features which are not compatible with your proposed solution?

*Solution*

The CSP Act-On-Behalf-Of approach to partner access to customer subscriptions has the following drawbacks:
-  It only works for CSP subscriptions. It does not work for other subscription types (PAYG, EA) which are used by some CCS cusotmers
-  It only grants 'Owner' permissions, which some customers find excessive, creating a security objection for the customer
-  Each admin is granted access to all CSP subscriptions. There is no ability to fine tune which operations team staff have access to which subscriptions

The AAD B2B Collaboration approach (also known as guest users) has the following drawbacks:
- It does not support user groups, and therefore requires each operations team member to be individually enrolled by each customer
- It requires the operations staff to switch context between each customer's directory. There is no 'all up' capability for reporting across customers.

Azure Lighthouse offers significant advantages over both of these approaches, and is the recommended solution.

With Azure Lighthouse, subscriptions or resource groups from the customer tenant are 'projected' into the partner tenant. Operations staff within the partner authenticate to the partner tenant, from where they are able to access and manage the projected resources as if they were local to the partner tenant.

Permissions are granted as part of the delegation, are fully visible to the customer, and cannot be changed later by the partner.  Permissions can be granted to AAD groups, rather than individual users, allowing the partner to manage group membership without customer impact. Permissions can also be granted to service principals, enabling partner automation also to access customer subscriptions.

There are two ways to enrol a customer with a partner using Azure Lighthouse:
- Using a Resource Manager Template
- Using the Azure Marketplace

In the template-based approach, the customer uses a template to deploy a resource of type `Microsoft.ManagedServices/registrationDefinitions` into their subscription. The resource properties specify which partner is to be granted access (AAD TenantID), which permissions will be granted to the partner (Azure roles), and which users or groups will receive those permissions (AAD ObjectIDs). This information should be obtained from the partner beforehand - in practice, the partner will prepare the template for the customer to deploy.

The registrationDefinition creates the customer/partner relationship. The customer can then delegate either the entire subscription or individual resource groups by creating a resource of type `Microsoft.ManagedServices/registrationAssignments` at the corresponding scope. The registration assignment has a single property, referencing the registration definition. This resource can also be created using a template, or can be managed via the Azure Portal (via the 'Service Providers' experience).

Alternatively, the partner can publish their managed service offering via the Azure Marketplace. To do this, they will need to enrol in the 'Commercial Marketplace' program via Partner Center. This requires a Silver or Gold 'Cloud Platform' competency. The partner will then create a 'Managed Service' offering, specifying all the details included in the registration definition as described above (tenantID, roles, objectIDs) in addition to a description of their service. The customer can then enrol with the partner through this Marketplace offer, rather than by deploying a template. (This enrolment also creates a `Microsoft.ManagedServices/registrationDefinitions` resource in the customer subscription, so the two approaches work the same way.)


2.  **Backup configuration and monitoring** How can CCS monitor Azure Backup health? Design a solution that enables:
    - Visibility into backup health across all customers
    - Identify VMs without backup enabled
    - Raise alerts upon backup failure, across all customers
    - Ensure backup monitoring is correctly consistently applied to all Recovery Services Vaults

    Does your solution scale to the number of customers and subscriptions managed by CCS?

*Solution*

Azure Backup has recently delivered two new monitoring solutions (as preview): Backup Explorer and Backup Reports.

Backup Explorer provides a near-real-time dashboard of backup health. It is powered by the Azure Resource Graph, and hence does not require any additional diagnostics configuration, storage accounts, or Log Analytics workspaces. It is always available, for all Recovery Services Vaults. It only supports data from the past 7 days.

Backup Reports provide deeper analysis of backup performance, including storage space consumed and historical trends. This solution is built on Log Analytics. It requires the Recovery Services Vault to be configured to send diagnostic logs to the Log Analytics workspace, and data can take up to 24 hours to surface in the reports.

Both solutions are built using Azure Monitor Workbooks, and offer aggregated cross-tenant views across subscriptions delegated using Azure Lighthouse. There are no subscription limits with Backup Explorer; Backup Reports inherit the Log Analytics limit of 100 subscriptions per query, and hence a single report cannot span the entire CCS customer base.

For CCS, their dashboard should be based on Backup Explorer. This offers a near real-time view across all customer subscriptions. Failed backup items and jobs can be quickly located, and the dashboard can also be used as a launch pad to drill down for deeper investigation. For more information, see [https://docs.microsoft.com/en-us/azure/backup/monitor-azure-backup-with-backup-explorer].

Backup alerts can be delivered in two ways: alerts configured directly within the Recovery Services Vault (email only) or alerts based on Log Analytics queries and Azure Monitor. The built-in alerts have several limitations (for example, not supporting alerts from on-premises backups using Microsoft Azure Backup Server or System Center Data Protection Manager). For this reason, Log Analytics/Azure Monitor alerts should be used. These have the additional advantage of supporting Action Groups.

Log-based alerts should be configured based on the Azure Backup 'V2' diagnostic data schema. Note that V1 schema is planned for deprecation.

This requires that each Recovery Services Vault is configured to send diagnostic data to a Log Analytics workspace. A workspace in the customer subscription should be used, for billing and isolation (compliance) purposes. Diagnostic logging can be configured using Azure Policy (see '\[Preview\]: Deploy Diagnostic Settings for Recovery Services Vault to Log Analytics workspace for resource specific categories.') This policy supports remediation and can therefore also be used to configure existing recovery services vaults.

A separate policy assignment will be needed in each customer subscription. In addition, the alerts will also need to be configured per vault. This process should be automated (for example, using a Resource Manager template or Blueprint) so it can be applied consistently at scale across the CCS customer base.


3.  **Patch management** What alternatives to System Center does Azure offer for patch management? Design an approach that offers:
    - Support for on-premises and cloud-based servers
    - Support for both Windows Server and Linux
    - Automatic on-boarding for Azure virtual machines and VM scale sets

    How does your solution scale patch management across the CCS customer base?

*Solution*

Azure Update Management offers a comprehensive cloud-based solution for patch management. It supports any server: Windows or Linux, Azure or on-premises, or other clouds.

Azure Update Management is implemented using Azure Log Analytics and Azure Automation. For a list of supported regions, see [https://docs.microsoft.com/azure/automation/how-to/region-mappings].  There is no cost for using Update Management, you only pay for the data stored in Log Analytics.

Each server being managed must be enrolled in Azure Log Analytics - that is, it must have the Log Analytics agent (aka Microsoft Monitoring Agent or MMA) installed.

Azure Virtual Machines can be on-boarded to Log Analytics directly from the Azure portal, using the VM blade or the Log Analytics blade. For automatic deployment at scale, there are two approaches:
- You can use Security Center to on-board each VM to Log Analytics (see Security Center > Pricing & settings > choose subscription > Data Collection).
- You can use Azure Policy to deploy the Log Analytics extension. There are built-in policies for Windows and Linux VMs and VM scale sets (search definitions for 'Deploy Log Analytics'). These definitions are wrapped into policy initiatives, one for Windows and Linux VMs and one for Windows and Linux VM scale sets). These initiatives include additional policies to onboard the dependency agent requires by Azure Monitor for VMs (see requirements 4 below).

The Security Center approach applies to both existing and new VMs. However, it does not apply to VM scale sets (CHECKING: See [https://github.com/MicrosoftDocs/azure-docs/issues/54946]). The policy approach applies to new VMs and scale sets, and existing VMs can be updated using policy remediation. The policy approach also has the advantage of providing policy compliance reports so you can identify any VMs that are not on-boarded.

On-premises machines will need to be on-boarded to Log Analytics by installing the Log Analytics agent. Versions are available for Windows and Linux, with command-line installation enabling automated deployment.

Once a server is on-boarded to Log Analytics, it must then be on-boarded to Update Management. This can be achieved using the Update Management UI, which under the hood updates a saved search in Log Analytics to identify which servers are on-boarded. Alternatively, you can configure Update Management to simply apply to all servers in Log Analytics (optionally, also including new servers). Windows servers can also be on-boarded from Windows Admin Center.

Azure Update Management is managed from the Azure Automation account. Each account is linked to a single Log Analytics workspace. The recommended approach is to use one Log Analytics workspace per customer (for all subscriptions, if the customer has more than one). As such, update management will need to be performed on a per-customer basis. Unfortunately, there is no built-in facility to use update management across multiple workspaces from a single UI. To streamline the roll-out of  updates, CCS may choose to develop their own tooling to support multiple automation account and workspaces.

Why use a separate workspace per customer, rather than on-board all customers to a single, shared workspace? There are several reasons:
 - Cost management: A workspace per customer can be placed in the customer subscription. As such, it each customer automatically pays for their consumption. With a shared workspace, CCS would need to either absorb the Log Analytics costs, or implement a bespoke mechanism to apportion costs to their customers based on usage.
 - Security and Compliance: The Log Analytics workspace potentially contains sensitive data about the customer's production environment. Enterprise customers in particular are unlikely to accept storing this data outside their own subscription.


4.  **VM and server monitoring** Design a solution for monitoring Azure VMs and on-premises servers. Your solution should support:
    - Streamlined onboarding of all Azure VMs and selected on-premises servers
    - Support for dashboards and alerts based on both metrics and logs. 
    - Customer billing according to usage
    - Compliance with Enterprise customer security requirements that all logs remain within their subscription boundary

    How can you ensure your solution is deployed consistently across all CCS customers, for data gathering, alert configuration, and reporting?

    Can your solution deliver flexible and highly configurable dashboards of key performance data?
    
    Can your dashboards show data aggregated across the CCS customer base? What limitations apply?

*Solution*

Azure Monitor for VMs provides in-depth monitoring for Azure VMs, VM scale sets, and non-Azure servers running on-premises or in other clouds.

Azure Monitor for VMs is a Log Analytics-based solution. As such, initial on-boarding requires installing the Log Analytics agent and registering it to send data to a Log Analytics workspace. This will re-use the workspace already described for Update Management, avoiding additional costs from duplicated data. (Note also that while the Log Analytics agent for Windows can send data to up to 4 workspaces, the Linux agent is limited to a single workspace.)

In addition to the Log Analytics agent, for full functionality the dependency agent should also be installed. This captures process and network connection data from the VM enabling the inbound and outbound VM dependencies to be mapped. This is an optional feature which may not be necessary on all servers. However, it is very useful when planning workload migrations. As with the Log Analytics agent, the dependency agent can be deployed to Azure VMs using Azure policy, and to on-premises servers via the command line.

Once the agents are installed, the final deployment step is to configure the VM insights solution on the Log Analytics workspace. This is straightforward from the VM Insights blade in Azure Monitor; it can also be automated via a template.

Once data is gathered to Log Analytics, it can be used for a wide variety of monitoring scenarios. Azure monitor for VMs includes a number of pre-defined reports, such as 'top N' reports by various metrics such as CPU, memory and disk. The default views, as with Update Management, support a single workspace and therefore will be scoped to a single customer.

However, CCS can also build their own dashboards and charts using Azure Monitor Workbooks and their own Log Analytics queries (the default workbook queries could be a starting point). By using custom queries, CCS can create cross-workspace queries, enabling reports that span multiple customers. Azure Lighthouse plays a critical role here, providing access to workspaces from multiple customers from within the CCS tenant.

This enables CCS to break out of the 'per-customer' operations model and operate much more efficiently.

Unfortunately, there is a limit of 100 workspaces in any single Log Analytics query, so CCS will not be able to scale to all customers in a single dashboard. However, they would be able to consolidate into a small collection of dashboards, each for a group of customers.

Log-based and metric-based alerts can be implemented using Azure Alerts. There is no need for cross-workspace queries in this case. Instead, the alert deployment should be automated using Azure Resource Manager templates, and rolled out across each customer.


5.  **Automation of manual tasks** How can CCS automate their manual configuration tasks? Your solution must support:
    - Automation of Azure resource configuration tasks (e.g. VM resize, disk encryption, network changes)
    - Automation of operations for Azure VMs (e.g. rotating passwords, installing or uninstalling software, auditing permissions)
    - Automation of operations for on-premises servers

    How can you deploy automation at scale across the CCS customer base?

    How can you review the success or failure of each automation task, on each resource?

    Automating common tasks is a substantial investment in IP. How can you protect the confidentiality of this investment?

*Solution*

Azure Automation provides a platform for automating Azure resource management tasks, as well as other administration tasks.

Automation can be extended to run outside of Azure using Hybrid Runbook Workers. These are servers deployed into the customer environment, and used to execute automation runbooks. They provide access to on-premises servers and avoid the usage restrictions on Azure sandbox execution environments.

Automation can manage Azure resources, using Azure PowerShell. This supports all resource configuration options such as VM resize, disk encryption, and network changes.

Automation can also execute scripts within Azure VMs, by calling the 'Run Command' VM feature. This allows the automation to specify a separate PowerShell (Windows) or Shell (Linux) script and execute it within the VM. These scripts can execute arbitrary tasks such as software installation, or changing passwords. The maximum script duration is 90 minutes.

For non-Azure servers, the Hybrid Runbook Worker can execute automation runbooks, and through these can remotely administer the on-premises servers. Workers should be configured in each CCS data center. Workers can also be used to remote-execute scripts on Azure VMs without using the Run Command feature.

Within Azure Automation, the output of each job (script execution) can be reviewed, together with details of any error output or exceptions. When using the Run Command feature, the script output is limited to the last 4,096 characters, which should be sufficient to determine success or failure.

To protect CCS IP, the automation account for the runbooks can be located in a CCS-owned subscription. It can access the customer subscriptions using Azure Lighthouse (the Service Principal account associated with the Automation Account must be included in the Lighthouse RBAC configuration). The customers will have no visibility into the automation account or runbooks, protecting CCS IP.


6.  **PaaS monitoring** Design a solution for monitoring PaaS services, in particular Azure SQL Database and Azure Web Apps. Your solution should support:
    - Gathering key metrics and log data for alerting and investigation of incidents
    - Configuration of alerts in the event of performance degradation (e.g. increased latency), errors, or critical events.

    What can you do to make your monitoring more representative of the end-user experience?

    A customer raises a support ticket claiming their application is 'slow'. How can your monitoring help investigate the cause?

*Solution*

As a PaaS service, Web Apps have different monitoring needs than IaaS services, and provides several integrated approaches for monitoring implementation.

Azure Web Apps has built-in support for a wide range of common metrics. Some of these are platform metrics, such as memory consumed and percentage file system used. While Web Apps are a platform service, you are still responsible for choosing the correct instance size and these metrics can be helpful when making that choice. Other metrics reflect application performance, such as response latency or 4xx response count. For a full list, see [https://docs.microsoft.com/azure/app-service/web-sites-monitor#understand-metrics]. These metrics can be used for dashboards and alerts (for example, alerting on a rise in 4xx responses, or latency).

Azure Web Apps also supports integrated logging, wth 5 types of logs supported: application logs, web server logs, error logs, failed request tracing, and deployment logs. Full details are at [https://docs.microsoft.com/azure/app-service/troubleshoot-diagnostic-logs]. These logs can be used for in-depth investigation of issues.

In addition, Web Apps can be integrated with Application Insights (see [https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview]), for more detailed diagnostics. For example, for Application Insights provides distributed tracing of calls for microservices-based applications.

The basic level of monitoring in Application Insights is agent-based monitoring. This is only available for .NET and .NET Core applications. It is fully integrated into the App Service and can simply be enabled from the Azure portal.

For more advanced monitoring, or for other platforms, the application can be instrumented by installing the Application Insights SDK. This approach also supports custom metrics and events, use of which enables monitoring to be extended to Linux-based workloads.

To gain more insight into the end customer experience, web applications can be instrumented with the Application Insights JavaScript SDK. This gives detailed data on the client-side user experience such as page load times.

Azure SQL Database is also a platform services, and supports a range of appropriate monitoring features. As a starting point, there are a range of metrics which can be viewed in Azure Data Studio or SQL Server Management Studio.

For in-depth monitoring, metrics and logs can be exported to a Log Analytics workspace, and analyzed using Azure SQL Analytics (see [https://docs.microsoft.com/azure/azure-monitor/insights/azure-sql]). This approach only supports SQL Database and SQL Database managed instances, not SQL Server on-premises or in Azure virtual machines. It can scale to multiple databases, but is limited to a single Log Analytics workspace. As with the VM Insights solution CCS will need to use a separate report per customer or build their own cross-workspace queries.

To help tune your database, Database Advisors provides recommendations and automatic tuning options to improve performance. The SQL Intelligent Insights solution compares database performance from the past hour with the past week using AI. This enables proactive maintenance, early detection of degradation, and tailored performance improvements.


7.  **VM and server compliance**  Propose a solution that enables CCS to audit the compliance of their entire server estate - Windows and Linux, on-premises and cloud.

    Your solution should support a wide range of common OS configuration issues, such as members of the local administrator group, password complexity, installed applications, and trusted certificates. The solution should also be extensible to support new issues as required by CCS.

    Explain how this solution scales to all CCS customers.

*Solution*

Compliance of Azure VMs can be audited using VM guest policy.  This allows policies to be deployed to an agent running in the VM, and policy compliance reported back through the Azure portal.

A range of built-in policies is available. For Windows VMs, these include checks on time zone, certificates, local administrators, password complexity, installed software, and more. For Linux VMs the range is more limited, but still include password and installed software policies.

You can also build custom guest policies, for both Windows and Linux. These allow CCS to extend the guest policy solution to address any new or existing scenarios not met by the built-in policies. See [https://docs.microsoft.com/azure/governance/policy/how-to/guest-configuration-create and https://docs.microsoft.com/azure/governance/policy/how-to/guest-configuration-create-linux] for details.

This solution can also be extended to on-premises servers using Azure Arc. By installing the Azure Connected Machine agent on on-premises servers, they can be registered as a resource in Azure. This allows VM guest policy to be applied to non-Azure servers, surfacing non-compliance in the same compliance report as the Azure VMs.

VM guest policy only detects issues, it does not fix them. Remediation can be achieved manually or through Azure Automation (see earlier).

Azure Lighthouse does not support Management Groups. As such, the VM guest policy will have to be assigned to each customer subscription separately. This can be automated through Azure Automation. Automation is strongly recommended to enable both consistent deployment and streamlining of future updates. A separate policy assignment means there will be separate compliance reports. For an aggregated report, CCS will need to query the compliance of each policy assignment using the Azure APIs/SDKs, and pool the results.


8.  **Cost management** Explain how CCS can meet their cost management requirements. These include:
    - Visibility into current and historical spend, with the ability to segment the data by a variety of categories (such as location, resource type, or tags)
    - Forecast of future spend
    - Cost saving recommendations
    - Configuration of spending alerts, including alerting at 1-day granularity in case of a spike in spending

    Cost reports should be available to customers, including CSP customers. However, any CSP discounts should be confidential to CCS.

*Solution*

Azure Cost Management is an out-of-the-box cost management solution for Azure. It supports all of the features listed - cost analysis (including segmentation), forecasts, recommendations (shared with Azure Advisor) and alerts.

Alerts can only be configured on cumulative spend (for the month, quarter or year), not daily spend. This makes it hard to alert quickly on a sudden spike in spend which may yet fall below the monthly budget. To mitigate, it's a good idea to review the daily costs report regularly. You can also configure a daily export to a storage account, and use Azure Automation to implement your own daily cost alerts. This approach also scales to multiple customers.

For CSP customers, Azure Cost Management requires that the customer has signed the Microsoft Customer Agreement and purchased an Azure Plan. Cost visibility must be enabled by the partner (CCS) for each customer tenant. CSP customers see costs computed at the Azure pay-as-you-go rates.

## Checklist of preferred objection handling

1.  Cost is a concern. As well as being cost-efficient, CCS prefer solutions that keep any costs associated with managing a customer solution within the customer subscription, rather than centralizing management costs into a CCS subscription and then having to apportion across customers.

    *Response*

    Most of the solutions proposed can be implemented in the customer's Azure subscription, then accessed by CCS via Azure Lighthouse.

    The largest cost driver is data storage is Log Analytics, which is always placed in the customer subscriptions. These costs can also be reduced by using capacity reservations.

    The only exception is the use of Azure Automation to automate previously manual administrative tasks. This is placed in a CCS subscription to provide access across customers (via Lighthouse) and protect CCS IP. These costs will need to be either absorbed or cross-charged to the customers based on usage.


2.  CCS are finding that their new enterprise customers are more demanding regarding security and compliance. How can CCS demonstrate their services meet enterprise standards for secure operations?

    *Response*

    Access to customer subscriptions by CCS staff is secured as follows:
    - Azure Lighthouse limits the permissions granted to CCS staff to specific roles which are reviewed by the customer in advance
    - Azure AD multi-factor authentication can be used by CCS to secure staff accounts against compromise
    - Additional AAD features, such as Privileged Identity Management, can secure accounts in AAD used for CCS staff administration
    - Azure Policy can be used to control permitted activities, and applies equally to customers and CCS staff accessing customer subscritions via Lighthouse
    - The Azure Activity Log records all operations, including CCS operations on customer subscriptions using Azure Lighthouse


## Customer quote (to be read back to the attendees at the end)

Azure Lighthouse is a game-changer, enabling us to dramatically streamline our management services hosted in customer subscriptions. We can now create cross-customer management experiences and automated approaches to many of our most common management scenarios. This is a huge improvement on per-customer management. There are still a few areas where per-customer management is required, and we look forward to future improvements.

Jack Walsh, CEO, Contoso Cloud Services


